<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confidence Intervals - Interactive Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                packages: ['base', 'ams', 'noerrors', 'noundefined'],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                enableMenu: false,
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #FAF9F6; 
            color: #374151; 
            scroll-behavior: smooth; 
        }
        .nav-button { 
            transition: all 0.3s ease; 
            border-bottom: 3px solid transparent; 
        }
        .nav-button.active { 
            border-color: #4338CA; 
            color: #4338CA; 
            font-weight: 600; 
        }
        .nav-button:not(.active):hover { 
            border-color: #6366F1; 
            color: #6366F1; 
        }
        .content-section { 
            min-height: calc(100vh - 180px); 
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .section-intro { 
            font-size: 1.125rem; 
            color: #4B5563; 
            margin-bottom: 1.5rem; 
            text-align: center; 
            max-width: 800px; 
            margin-left: auto; 
            margin-right: auto; 
        }
        .interactive-panel {
            background-color: #eef2ff;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        }
        .interactive-panel .panel-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #4338CA;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        input[type="number"], select, textarea {
            padding: 0.6rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #c7d2fe;
            background-color: white;
            font-size: 1rem;
            color: #374151;
            width: 100%;
            max-width: 250px;
            margin-bottom: 0.5rem;
        }
        .calculate-button, .simulate-button {
            background-color: #4338CA;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            margin-top: 1rem;
            display: block;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            border: none;
        }
        .calculate-button:hover, .simulate-button:hover {
            background-color: #6366F1;
            transform: translateY(-1px);
        }
        .results-box {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-top: 1.5rem;
        }
        .results-box h4 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .interpretation-box {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #D1FAE5;
            color: #065F46;
            border: 1px solid #34D399;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin: 2rem 0;
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }
        .input-group label {
            font-weight: 500;
            color: #4B5563;
            min-width: 150px;
            text-align: right;
        }
        .ci-visualization {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 0.75rem;
            padding: 2rem;
            margin: 2rem 0;
        }
        .simulation-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: center;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <h1 class="text-2xl sm:text-3xl font-bold text-center text-indigo-700">Confidence Intervals - Interactive Guide</h1>
            <nav class="mt-4">
                <ul class="flex flex-wrap justify-center gap-3 sm:gap-6">
                    <li><a href="#theory" class="nav-button active text-sm sm:text-base font-medium py-2 px-3" onclick="showSection('theory')">📚 Theory</a></li>
                    <li><a href="#practical" class="nav-button text-sm sm:text-base font-medium py-2 px-3" onclick="showSection('practical')">💡 Practical</a></li>
                    <li><a href="#simulation" class="nav-button text-sm sm:text-base font-medium py-2 px-3" onclick="showSection('simulation')">🎮 Simulation</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow">
        
        <!-- Theory Section -->
        <section id="theory" class="content-section active">
            <div class="text-center">
                <h2 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-4">
                    <span class="text-indigo-600">📊</span> Confidence Intervals Theory
                </h2>
                <p class="section-intro">
                    Confidence intervals provide a range of plausible values for unknown population parameters, 
                    quantifying the uncertainty in our estimates.
                </p>
            </div>

            <div class="grid md:grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                <!-- What are Confidence Intervals -->
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h3 class="text-2xl font-semibold text-indigo-700 mb-4">What are Confidence Intervals?</h3>
                    <p class="text-gray-600 mb-4">
                        A confidence interval is an estimated range of values that likely contains an unknown population parameter.
                    </p>
                    
                    <h4 class="text-lg font-semibold mb-2">Key Concepts:</h4>
                    <ul class="list-disc list-inside text-gray-600 space-y-2">
                        <li><strong>Point Estimate:</strong> Single value estimate (e.g., sample mean)</li>
                        <li><strong>Interval Estimate:</strong> Range of plausible values</li>
                        <li><strong>Confidence Level:</strong> Long-run probability of capturing the true parameter</li>
                        <li><strong>Margin of Error:</strong> Half-width of the confidence interval</li>
                    </ul>

                    <div class="bg-gray-50 p-4 rounded-lg mt-4">
                        <h5 class="font-semibold mb-2">General Form:</h5>
                        $$CI = \text{Point Estimate} \pm \text{Margin of Error}$$
                        $$CI = \bar{x} \pm E$$
                    </div>
                </div>

                <!-- Confidence Interval for Mean -->
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h3 class="text-2xl font-semibold text-indigo-700 mb-4">Confidence Interval for Mean</h3>
                    <p class="text-gray-600 mb-4">
                        The most common type of confidence interval estimates the population mean μ.
                    </p>
                    
                    <h4 class="text-lg font-semibold mb-2">When σ is known (Z-interval):</h4>
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        $$CI = \bar{x} \pm z_{\alpha/2} \cdot \frac{\sigma}{\sqrt{n}}$$
                    </div>

                    <h4 class="text-lg font-semibold mb-2">When σ is unknown (t-interval):</h4>
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        $$CI = \bar{x} \pm t_{\alpha/2,df} \cdot \frac{s}{\sqrt{n}}$$
                        <p class="text-sm text-gray-600 mt-2">where df = n - 1</p>
                    </div>

                    <h4 class="text-lg font-semibold mb-2">Critical Values:</h4>
                    <ul class="list-disc list-inside text-gray-600 space-y-1">
                        <li>90% CI: z = 1.645</li>
                        <li>95% CI: z = 1.96</li>
                        <li>99% CI: z = 2.576</li>
                    </ul>
                </div>
            </div>

            <!-- Interpretation -->
            <div class="bg-white rounded-xl p-6 shadow-lg mt-8">
                <h3 class="text-2xl font-semibold text-indigo-700 mb-4">Proper Interpretation</h3>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h4 class="text-lg font-semibold text-green-800 mb-2">✅ Correct Interpretation</h4>
                        <p class="text-green-700">
                            "We are 95% confident that the true population mean lies between 
                            [lower bound] and [upper bound]."
                        </p>
                        <p class="text-green-700 mt-2">
                            This means that if we repeated this process many times, 
                            about 95% of the intervals would contain the true mean.
                        </p>
                    </div>
                    
                    <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                        <h4 class="text-lg font-semibold text-red-800 mb-2">❌ Incorrect Interpretation</h4>
                        <p class="text-red-700">
                            "There is a 95% probability that the true mean is in this interval."
                        </p>
                        <p class="text-red-700 mt-2">
                            The parameter is fixed; the interval either contains it or doesn't. 
                            The probability refers to the method, not a specific interval.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Practical Section -->
        <section id="practical" class="content-section">
            <div class="text-center">
                <h2 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-4">
                    <span class="text-indigo-600">💡</span> Confidence Interval Calculator
                </h2>
                <p class="section-intro">
                    Calculate confidence intervals for population means with step-by-step results and interpretations.
                </p>
            </div>

            <!-- Confidence Interval Calculator -->
            <div class="interactive-panel">
                <h3 class="panel-title">Confidence Interval for Population Mean</h3>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <div class="input-group">
                            <label for="sampleMean">Sample Mean (x̄):</label>
                            <input type="number" id="sampleMean" value="100" step="any">
                        </div>
                        
                        <div class="input-group">
                            <label for="sampleSize">Sample Size (n):</label>
                            <input type="number" id="sampleSize" value="25" min="1">
                        </div>
                        
                        <div class="input-group">
                            <label for="confidenceLevel">Confidence Level:</label>
                            <select id="confidenceLevel">
                                <option value="90">90%</option>
                                <option value="95" selected>95%</option>
                                <option value="99">99%</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <div class="input-group">
                            <label for="intervalType">Interval Type:</label>
                            <select id="intervalType" onchange="toggleSigmaInput()">
                                <option value="z">Z-interval (σ known)</option>
                                <option value="t" selected>t-interval (σ unknown)</option>
                            </select>
                        </div>
                        
                        <div class="input-group" id="sigmaGroup">
                            <label for="populationSigma">Population σ:</label>
                            <input type="number" id="populationSigma" value="15" step="any">
                        </div>
                        
                        <div class="input-group" id="sampleStdGroup">
                            <label for="sampleStd">Sample Std Dev (s):</label>
                            <input type="number" id="sampleStd" value="12" step="any">
                        </div>
                    </div>
                </div>

                <button class="calculate-button" onclick="calculateConfidenceInterval()">Calculate Confidence Interval</button>

                <div id="ciResults" class="results-box" style="display: none;">
                    <h4>Confidence Interval Results</h4>
                    <div id="ciResultsContent"></div>
                </div>
            </div>

            <!-- Visualization -->
            <div class="ci-visualization">
                <h3 class="text-xl font-semibold text-indigo-700 mb-4 text-center">Confidence Interval Visualization</h3>
                <div class="chart-container">
                    <canvas id="ciChart"></canvas>
                </div>
            </div>

            <!-- Sample Size Calculator -->
            <div class="interactive-panel">
                <h3 class="panel-title">Sample Size Calculator</h3>
                <p class="text-center text-gray-600 mb-4">Determine the required sample size for a desired margin of error</p>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="input-group">
                        <label for="desiredMargin">Desired Margin of Error:</label>
                        <input type="number" id="desiredMargin" value="2" step="any">
                    </div>
                    
                    <div class="input-group">
                        <label for="estimatedSigma">Estimated σ:</label>
                        <input type="number" id="estimatedSigma" value="15" step="any">
                    </div>
                    
                    <div class="input-group">
                        <label for="sampleConfidence">Confidence Level:</label>
                        <select id="sampleConfidence">
                            <option value="90">90%</option>
                            <option value="95" selected>95%</option>
                            <option value="99">99%</option>
                        </select>
                    </div>
                </div>

                <button class="calculate-button" onclick="calculateSampleSize()">Calculate Required Sample Size</button>

                <div id="sampleSizeResults" class="results-box" style="display: none;">
                    <h4>Sample Size Results</h4>
                    <div id="sampleSizeContent"></div>
                </div>
            </div>
        </section>

        <!-- Simulation Section -->
        <section id="simulation" class="content-section">
            <div class="text-center">
                <h2 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-4">
                    <span class="text-indigo-600">🎮</span> Confidence Interval Simulation
                </h2>
                <p class="section-intro">
                    Explore how confidence intervals behave across multiple samples and understand coverage probability.
                </p>
            </div>

            <div class="interactive-panel">
                <h3 class="panel-title">Confidence Interval Coverage Simulation</h3>
                
                <div class="simulation-controls">
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="input-group">
                            <label for="simPopMean">True Population Mean (μ):</label>
                            <input type="number" id="simPopMean" value="50" step="any">
                        </div>
                        
                        <div class="input-group">
                            <label for="simPopSigma">Population Std Dev (σ):</label>
                            <input type="number" id="simPopSigma" value="10" step="any">
                        </div>
                        
                        <div class="input-group">
                            <label for="simSampleSize">Sample Size per CI:</label>
                            <input type="number" id="simSampleSize" value="25" min="5">
                        </div>
                        
                        <div class="input-group">
                            <label for="simConfLevel">Confidence Level:</label>
                            <select id="simConfLevel">
                                <option value="90">90%</option>
                                <option value="95" selected>95%</option>
                                <option value="99">99%</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="numIntervals">Number of Intervals:</label>
                        <input type="number" id="numIntervals" value="100" min="10" max="1000">
                    </div>
                    
                    <button class="simulate-button" onclick="runCoverageSimulation()">Run Coverage Simulation</button>
                </div>

                <div class="chart-container">
                    <canvas id="simulationChart"></canvas>
                </div>

                <div id="simulationResults" class="results-box" style="display: none;">
                    <h4>Simulation Results</h4>
                    <div id="simulationContent"></div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-white border-t mt-16">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center text-gray-600">
            <p>&copy; 2025 Statistical Education Tool. Interactive learning for confidence intervals.</p>
        </div>
    </footer>

    <script>
        let ciChart = null;
        let simulationChart = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Register Chart.js plugins
            if (typeof Chart !== 'undefined' && typeof ChartAnnotation !== 'undefined') {
                Chart.register(ChartAnnotation);
            }
            
            // Initialize with default calculation
            toggleSigmaInput();
            calculateConfidenceInterval();
            
            // Initialize MathJax if available
            if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise();
            }
        });

        // Navigation functions
        function showSection(sectionId) {
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => section.classList.remove('active'));
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Update navigation
            const navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(button => button.classList.remove('active'));
            document.querySelector(`[onclick="showSection('${sectionId}')"]`).classList.add('active');
        }

        // Toggle sigma input based on interval type
        function toggleSigmaInput() {
            const intervalType = document.getElementById('intervalType').value;
            const sigmaGroup = document.getElementById('sigmaGroup');
            const sampleStdGroup = document.getElementById('sampleStdGroup');
            
            if (intervalType === 'z') {
                sigmaGroup.style.display = 'flex';
                sampleStdGroup.style.display = 'none';
            } else {
                sigmaGroup.style.display = 'none';
                sampleStdGroup.style.display = 'flex';
            }
        }

        // Get critical value
        function getCriticalValue(confidenceLevel, intervalType, df = null) {
            const alpha = (100 - confidenceLevel) / 100;
            
            if (intervalType === 'z') {
                switch (confidenceLevel) {
                    case 90: return 1.645;
                    case 95: return 1.96;
                    case 99: return 2.576;
                    default: return 1.96;
                }
            } else {
                // t-distribution (approximation for common values)
                const tTable = {
                    90: { 5: 2.015, 10: 1.812, 15: 1.753, 20: 1.725, 24: 1.711, 30: 1.697, 50: 1.676, 100: 1.660 },
                    95: { 5: 2.571, 10: 2.228, 15: 2.131, 20: 2.086, 24: 2.064, 30: 2.042, 50: 2.009, 100: 1.984 },
                    99: { 5: 4.032, 10: 3.169, 15: 2.947, 20: 2.845, 24: 2.797, 30: 2.750, 50: 2.678, 100: 2.626 }
                };
                
                const table = tTable[confidenceLevel];
                if (!table) return 1.96;
                
                // Find closest df
                const dfs = Object.keys(table).map(Number).sort((a, b) => a - b);
                let closestDf = dfs[dfs.length - 1]; // default to largest
                
                for (let i = 0; i < dfs.length; i++) {
                    if (df <= dfs[i]) {
                        closestDf = dfs[i];
                        break;
                    }
                }
                
                return table[closestDf];
            }
        }

        // Calculate confidence interval
        function calculateConfidenceInterval() {
            try {
                const sampleMean = parseFloat(document.getElementById('sampleMean').value);
                const sampleSize = parseInt(document.getElementById('sampleSize').value);
                const confidenceLevel = parseInt(document.getElementById('confidenceLevel').value);
                const intervalType = document.getElementById('intervalType').value;
                
                let standardError;
                let criticalValue;
                let df = null;
                
                if (intervalType === 'z') {
                    const populationSigma = parseFloat(document.getElementById('populationSigma').value);
                    standardError = populationSigma / Math.sqrt(sampleSize);
                    criticalValue = getCriticalValue(confidenceLevel, 'z');
                } else {
                    const sampleStd = parseFloat(document.getElementById('sampleStd').value);
                    standardError = sampleStd / Math.sqrt(sampleSize);
                    df = sampleSize - 1;
                    criticalValue = getCriticalValue(confidenceLevel, 't', df);
                }
                
                const marginOfError = criticalValue * standardError;
                const lowerBound = sampleMean - marginOfError;
                const upperBound = sampleMean + marginOfError;
                
                displayCIResults({
                    sampleMean, sampleSize, confidenceLevel, intervalType,
                    standardError, criticalValue, marginOfError,
                    lowerBound, upperBound, df
                });
                
                visualizeCI(sampleMean, lowerBound, upperBound, confidenceLevel);
                
            } catch (error) {
                alert('Error in calculation: ' + error.message);
            }
        }

        // Display confidence interval results
        function displayCIResults(results) {
            const resultsDiv = document.getElementById('ciResults');
            const contentDiv = document.getElementById('ciResultsContent');
            
            const dfText = results.df !== null ? `, df = ${results.df}` : '';
            
            contentDiv.innerHTML = `
                <div class="result-item">
                    <span class="result-label">Sample Mean (x̄):</span>
                    <span class="result-value">${results.sampleMean.toFixed(4)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Sample Size (n):</span>
                    <span class="result-value">${results.sampleSize}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Confidence Level:</span>
                    <span class="result-value">${results.confidenceLevel}%</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Critical Value:</span>
                    <span class="result-value">${results.criticalValue.toFixed(4)}${dfText}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Standard Error:</span>
                    <span class="result-value">${results.standardError.toFixed(4)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Margin of Error:</span>
                    <span class="result-value">±${results.marginOfError.toFixed(4)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Confidence Interval:</span>
                    <span class="result-value">[${results.lowerBound.toFixed(4)}, ${results.upperBound.toFixed(4)}]</span>
                </div>
                <div class="interpretation-box">
                    <strong>Interpretation:</strong> We are ${results.confidenceLevel}% confident that the true population mean lies between ${results.lowerBound.toFixed(4)} and ${results.upperBound.toFixed(4)}.
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        // Visualize confidence interval
        function visualizeCI(mean, lower, upper, confidence) {
            const ctx = document.getElementById('ciChart').getContext('2d');
            
            if (ciChart) {
                ciChart.destroy();
            }
            
            const range = upper - lower;
            const padding = range * 0.5;
            const xMin = lower - padding;
            const xMax = upper + padding;
            
            // Generate normal distribution curve
            const points = [];
            const step = (xMax - xMin) / 200;
            const sigma = range / (2 * 1.96); // approximate
            
            for (let x = xMin; x <= xMax; x += step) {
                const y = (1 / (sigma * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - mean) / sigma, 2));
                points.push({x: x, y: y});
            }
            
            ciChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Sampling Distribution',
                            data: points,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Sample Mean',
                            data: [{x: mean, y: 0}],
                            backgroundColor: 'red',
                            borderColor: 'red',
                            pointRadius: 8,
                            showLine: false,
                            type: 'scatter'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Probability Density'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${confidence}% Confidence Interval: [${lower.toFixed(2)}, ${upper.toFixed(2)}]`
                        },
                        annotation: {
                            annotations: {
                                lowerBound: {
                                    type: 'line',
                                    xMin: lower,
                                    xMax: lower,
                                    borderColor: 'green',
                                    borderWidth: 3,
                                    label: {
                                        content: `Lower: ${lower.toFixed(2)}`,
                                        enabled: true,
                                        position: 'start'
                                    }
                                },
                                upperBound: {
                                    type: 'line',
                                    xMin: upper,
                                    xMax: upper,
                                    borderColor: 'green',
                                    borderWidth: 3,
                                    label: {
                                        content: `Upper: ${upper.toFixed(2)}`,
                                        enabled: true,
                                        position: 'start'
                                    }
                                },
                                ciRegion: {
                                    type: 'box',
                                    xMin: lower,
                                    xMax: upper,
                                    backgroundColor: 'rgba(34, 197, 94, 0.2)',
                                    borderColor: 'rgba(34, 197, 94, 0.5)',
                                    borderWidth: 1
                                }
                            }
                        }
                    }
                }
            });
        }

        // Calculate required sample size
        function calculateSampleSize() {
            try {
                const marginOfError = parseFloat(document.getElementById('desiredMargin').value);
                const sigma = parseFloat(document.getElementById('estimatedSigma').value);
                const confidenceLevel = parseInt(document.getElementById('sampleConfidence').value);
                
                const criticalValue = getCriticalValue(confidenceLevel, 'z');
                const requiredSize = Math.pow((criticalValue * sigma) / marginOfError, 2);
                const roundedSize = Math.ceil(requiredSize);
                
                const resultsDiv = document.getElementById('sampleSizeResults');
                const contentDiv = document.getElementById('sampleSizeContent');
                
                contentDiv.innerHTML = `
                    <div class="result-item">
                        <span class="result-label">Desired Margin of Error:</span>
                        <span class="result-value">±${marginOfError}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Estimated σ:</span>
                        <span class="result-value">${sigma}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Confidence Level:</span>
                        <span class="result-value">${confidenceLevel}%</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Critical Value:</span>
                        <span class="result-value">${criticalValue.toFixed(4)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Calculated Sample Size:</span>
                        <span class="result-value">${requiredSize.toFixed(2)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Required Sample Size:</span>
                        <span class="result-value">${roundedSize}</span>
                    </div>
                    <div class="interpretation-box">
                        <strong>Recommendation:</strong> You need at least ${roundedSize} observations to achieve a margin of error of ±${marginOfError} with ${confidenceLevel}% confidence.
                    </div>
                `;
                
                resultsDiv.style.display = 'block';
                
            } catch (error) {
                alert('Error in sample size calculation: ' + error.message);
            }
        }

        // Run coverage simulation
        function runCoverageSimulation() {
            try {
                const trueMean = parseFloat(document.getElementById('simPopMean').value);
                const trueSigma = parseFloat(document.getElementById('simPopSigma').value);
                const sampleSize = parseInt(document.getElementById('simSampleSize').value);
                const confidenceLevel = parseInt(document.getElementById('simConfLevel').value);
                const numIntervals = parseInt(document.getElementById('numIntervals').value);
                
                const criticalValue = getCriticalValue(confidenceLevel, 'z');
                const intervals = [];
                let coverageCount = 0;
                
                // Generate random samples and confidence intervals
                for (let i = 0; i < numIntervals; i++) {
                    const sample = generateNormalSample(trueMean, trueSigma, sampleSize);
                    const sampleMean = sample.reduce((a, b) => a + b, 0) / sampleSize;
                    const standardError = trueSigma / Math.sqrt(sampleSize);
                    const marginOfError = criticalValue * standardError;
                    
                    const lower = sampleMean - marginOfError;
                    const upper = sampleMean + marginOfError;
                    const covers = (trueMean >= lower && trueMean <= upper);
                    
                    if (covers) coverageCount++;
                    
                    intervals.push({
                        index: i,
                        sampleMean: sampleMean,
                        lower: lower,
                        upper: upper,
                        covers: covers
                    });
                }
                
                const coverageProbability = coverageCount / numIntervals;
                
                displaySimulationResults(coverageProbability, confidenceLevel, numIntervals, coverageCount);
                visualizeSimulation(intervals, trueMean, Math.min(50, numIntervals));
                
            } catch (error) {
                alert('Error in simulation: ' + error.message);
            }
        }

        // Generate normal sample
        function generateNormalSample(mean, sigma, size) {
            const sample = [];
            for (let i = 0; i < size; i++) {
                sample.push(generateNormal(mean, sigma));
            }
            return sample;
        }

        // Generate normal random variable
        function generateNormal(mean = 0, sigma = 1) {
            const u1 = Math.random();
            const u2 = Math.random();
            const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
            return mean + sigma * z;
        }

        // Display simulation results
        function displaySimulationResults(coverage, expectedCoverage, numIntervals, coverageCount) {
            const resultsDiv = document.getElementById('simulationResults');
            const contentDiv = document.getElementById('simulationContent');
            
            contentDiv.innerHTML = `
                <div class="result-item">
                    <span class="result-label">Number of Intervals:</span>
                    <span class="result-value">${numIntervals}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Expected Coverage:</span>
                    <span class="result-value">${expectedCoverage}%</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Intervals Covering True Mean:</span>
                    <span class="result-value">${coverageCount}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Observed Coverage:</span>
                    <span class="result-value">${(coverage * 100).toFixed(2)}%</span>
                </div>
                <div class="interpretation-box">
                    <strong>Result:</strong> Out of ${numIntervals} confidence intervals, ${coverageCount} (${(coverage * 100).toFixed(2)}%) contained the true population mean. 
                    This ${Math.abs(coverage * 100 - expectedCoverage) < 5 ? 'closely matches' : 'differs from'} the expected ${expectedCoverage}% coverage rate.
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        // Visualize simulation
        function visualizeSimulation(intervals, trueMean, maxDisplay) {
            const ctx = document.getElementById('simulationChart').getContext('2d');
            
            if (simulationChart) {
                simulationChart.destroy();
            }
            
            const displayIntervals = intervals.slice(0, maxDisplay);
            const labels = displayIntervals.map((_, i) => `CI ${i + 1}`);
            
            const datasets = [
                {
                    label: 'Lower Bound',
                    data: displayIntervals.map(interval => interval.lower),
                    backgroundColor: displayIntervals.map(interval => 
                        interval.covers ? 'rgba(34, 197, 94, 0.6)' : 'rgba(239, 68, 68, 0.6)'
                    ),
                    borderColor: displayIntervals.map(interval => 
                        interval.covers ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)'
                    ),
                    borderWidth: 1
                },
                {
                    label: 'Upper Bound',
                    data: displayIntervals.map(interval => interval.upper),
                    backgroundColor: displayIntervals.map(interval => 
                        interval.covers ? 'rgba(34, 197, 94, 0.6)' : 'rgba(239, 68, 68, 0.6)'
                    ),
                    borderColor: displayIntervals.map(interval => 
                        interval.covers ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)'
                    ),
                    borderWidth: 1
                }
            ];
            
            simulationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Confidence Intervals'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `First ${maxDisplay} Confidence Intervals (Green = Contains True Mean, Red = Misses)`
                        },
                        legend: {
                            display: false
                        },
                        annotation: {
                            annotations: {
                                trueMean: {
                                    type: 'line',
                                    xMin: trueMean,
                                    xMax: trueMean,
                                    borderColor: 'blue',
                                    borderWidth: 3,
                                    label: {
                                        content: `True Mean: ${trueMean}`,
                                        enabled: true,
                                        position: 'end'
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>